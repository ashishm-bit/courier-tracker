<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Courier Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">

  <h1 class="text-3xl font-bold mb-6 text-center">Courier Tracker</h1>

  <div class="flex justify-between items-center mb-4">
    <div class="flex space-x-4">
      <button class="tab-button tab-active bg-blue-500 text-white px-4 py-2 rounded" onclick="switchTab('operation', this)">Operation</button>
      <button class="tab-button bg-gray-200 px-4 py-2 rounded" onclick="switchTab('procurement', this)">Procurement</button>
      <button class="tab-button bg-gray-200 px-4 py-2 rounded" onclick="switchTab('reconciliation', this)">Reconciliation</button>
    </div>
    <div class="flex space-x-2">
      <button onclick="openModal()" class="bg-green-500 text-white px-4 py-2 rounded">Add Courier</button>
      <button onclick="exportCSV()" class="bg-yellow-500 text-white px-4 py-2 rounded">Export CSV</button>
    </div>
  </div>

  <div id="search-operation" class="mb-4">
    <input type="text" class="form-input w-full p-2 border rounded" placeholder="Search by Request ID, Vendor, Client, Courier, or Tracking ID..." oninput="renderTable(currentTab, this.value)">
  </div>
  <div id="search-procurement" class="mb-4 hidden">
    <input type="text" class="form-input w-full p-2 border rounded" placeholder="Search by Request ID, Vendor, Client, Courier, or Tracking ID..." oninput="renderTable(currentTab, this.value)">
  </div>
  <div id="search-reconciliation" class="mb-4 hidden">
    <input type="text" class="form-input w-full p-2 border rounded" placeholder="Search by Request ID, Vendor, or Client Name..." oninput="renderTable(currentTab, this.value)">
  </div>

  <div id="tab-operation" class="tab-section">
    <table class="w-full bg-white rounded shadow">
      <thead class="bg-blue-100">
        <tr><th class="p-2">Request ID</th><th>Vendor</th><th>Client Name</th><th>Courier</th><th>Tracking ID</th><th>Qty</th><th>Actions</th></tr>
      </thead>
      <tbody id="operation-table"></tbody>
    </table>
  </div>

  <div id="tab-procurement" class="tab-section hidden">
    <table class="w-full bg-white rounded shadow">
      <thead class="bg-green-100">
        <tr><th class="p-2">Request ID</th><th>Vendor</th><th>Client Name</th><th>Courier</th><th>Tracking ID</th><th>Qty</th><th>Status</th><th>Actions</th></tr>
      </thead>
      <tbody id="procurement-table"></tbody>
    </table>
  </div>

  <div id="tab-reconciliation" class="tab-section hidden">
    <table class="w-full bg-white rounded shadow">
      <thead class="bg-yellow-100">
        <tr>
            <th class="p-2">Request ID</th>
            <th>Vendor</th>
            <th>Client Name</th>
            <th>Procurement Qty</th>
            <th>Operation Qty</th>
            <th>Difference</th>
        </tr>
      </thead>
      <tbody id="reconciliation-table"></tbody>
    </table>
  </div>

  <div id="modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded shadow w-full max-w-md">
      <h2 class="text-xl font-bold mb-4">Add/Edit Courier</h2>
      <input id="courierDocId" type="hidden">
      <input id="requestId" class="form-input w-full mb-2 p-2 border rounded" placeholder="Request ID">
      <input id="vendorName" class="form-input w-full mb-2 p-2 border rounded" placeholder="Vendor Name">
      <input id="clientName" class="form-input w-full mb-2 p-2 border rounded" placeholder="Client Name">
      <input id="courierName" class="form-input w-full mb-2 p-2 border rounded" placeholder="Courier Name">
      <input id="trackingId" class="form-input w-full mb-2 p-2 border rounded" placeholder="Tracking ID">
      <input id="totalQuantity" type="number" class="form-input w-full mb-2 p-2 border rounded" placeholder="Total Quantity">
      <select id="tabCategory" class="form-input w-full mb-4 p-2 border rounded">
        <option value="operation">Operation</option>
        <option value="procurement">Procurement</option>
      </select>
      <div class="flex justify-end space-x-2">
        <button onclick="closeModal()" class="bg-gray-400 text-white px-4 py-2 rounded">Cancel</button>
        <button onclick="saveCourier()" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
      </div>
    </div>
  </div>
  
  <div id="quantityModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded shadow w-full max-w-sm">
      <h2 class="text-xl font-bold mb-4">Update Quantity</h2>
      <input id="quantityDocId" type="hidden">
      <div class="mb-2">
        <strong>Request ID:</strong> <span id="qtyModalRequestId"></span>
      </div>
      <div class="mb-4">
        <strong>Total Quantity:</strong> <span id="qtyModalTotalQuantity"></span>
      </div>
      <input id="newQuantity" type="number" class="form-input w-full mb-4 p-2 border rounded" placeholder="Enter quantity received">
      <div class="flex justify-end space-x-2">
        <button onclick="closeQuantityModal()" class="bg-gray-400 text-white px-4 py-2 rounded">Cancel</button>
        <button onclick="saveQuantity()" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // --- UPDATED: Firebase Configuration from your working file ---
    const firebaseConfig = {
      apiKey: "AIzaSyDSjx-dbBVsPODUvr2Umg8VGnm_uG2eXgw",
      authDomain: "courierportal-b6321.firebaseapp.com",
      projectId: "courierportal-b6321",
      storageBucket: "courierportal-b6321.firebasestorage.app",
      messagingSenderId: "694120822474",
      appId: "1:694120822474:web:43ddb6da2135c7aebfe633"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const courierCollection = db.collection("couriers");

    let courierData = []; 
    let currentTab = 'operation';

    function switchTab(tabName, button) {
      currentTab = tabName;
      document.querySelectorAll('.tab-section').forEach(t => t.classList.add('hidden'));
      document.getElementById(`tab-${tabName}`).classList.remove('hidden');
      document.querySelectorAll('[id^="search-"]').forEach(s => s.classList.add('hidden'));
      document.getElementById(`search-${tabName}`).classList.remove('hidden');
      document.querySelectorAll('.tab-button').forEach(b => {
        b.classList.remove('bg-blue-500', 'text-white');
        b.classList.add('bg-gray-200');
      });
      button.classList.add('bg-blue-500', 'text-white');
      button.classList.remove('bg-gray-200');
      renderTable(tabName, document.querySelector(`#search-${tabName} input`).value || '');
    }

    function openModal(docId = null) {
      document.getElementById('modal').classList.remove('hidden');
      if (docId) {
        const c = courierData.find(courier => courier.id === docId);
        document.getElementById('courierDocId').value = c.id;
        document.getElementById('requestId').value = c.requestId;
        document.getElementById('vendorName').value = c.vendorName;
        document.getElementById('clientName').value = c.clientName;
        document.getElementById('courierName').value = c.courierName;
        document.getElementById('trackingId').value = c.trackingId;
        document.getElementById('totalQuantity').value = c.totalQuantity;
        document.getElementById('tabCategory').value = c.category;
      } else {
        ['courierDocId','requestId','vendorName','clientName','courierName','trackingId','totalQuantity'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('tabCategory').value = currentTab;
      }
    }

    function closeModal() {
      document.getElementById('modal').classList.add('hidden');
    }
    
    function openQuantityModal(docId) {
        const courier = courierData.find(c => c.id === docId);
        document.getElementById('quantityDocId').value = docId;
        document.getElementById('qtyModalRequestId').innerText = courier.requestId;
        document.getElementById('qtyModalTotalQuantity').innerText = courier.totalQuantity;
        document.getElementById('newQuantity').value = courier.quantityReceived;
        document.getElementById('quantityModal').classList.remove('hidden');
    }
    
    function closeQuantityModal() {
        document.getElementById('quantityModal').classList.add('hidden');
    }

    function saveQuantity() {
        const docId = document.getElementById('quantityDocId').value;
        if (!docId) return;

        const newQty = parseInt(document.getElementById('newQuantity').value, 10);
        const courier = courierData.find(c => c.id === docId);
        const totalQty = parseInt(courier.totalQuantity, 10);

        if (isNaN(newQty) || newQty < 0) {
            return alert("Please enter a valid non-negative number.");
        }

        let newStatus = 'Live';
        if (newQty <= 0) {
            newStatus = 'Live';
        } else if (newQty >= totalQty) {
            newStatus = 'Completed';
        } else {
            newStatus = 'Partially Received';
        }

        courierCollection.doc(docId).update({
            quantityReceived: newQty,
            status: newStatus
        }).then(() => {
            console.log("Quantity updated successfully!");
            closeQuantityModal();
        }).catch(error => console.error("Error updating document: ", error));
    }

    function saveCourier() {
        const docId = document.getElementById('courierDocId').value;
        const courier = {
            requestId: document.getElementById('requestId').value,
            vendorName: document.getElementById('vendorName').value,
            clientName: document.getElementById('clientName').value,
            courierName: document.getElementById('courierName').value,
            trackingId: document.getElementById('trackingId').value,
            totalQuantity: parseInt(document.getElementById('totalQuantity').value, 10) || 0,
            category: document.getElementById('tabCategory').value
        };

        if(!courier.requestId || !courier.clientName) {
            return alert("Request ID and Client Name are required.");
        }

        if (docId) { 
            courierCollection.doc(docId).update(courier)
                .then(() => console.log("Document successfully updated!"))
                .catch(error => console.error("Error updating document: ", error));
        } else { 
            courier.quantityReceived = 0;
            courier.status = 'Live';
            courier.reconciled = false; // This field is no longer used for display
            courierCollection.add(courier)
                .then(() => console.log("Document successfully written!"))
                .catch(error => console.error("Error writing document: ", error));
        }
        closeModal();
    }

    function deleteCourier(docId) {
      if (confirm("Are you sure?")) {
        courierCollection.doc(docId).delete()
            .then(() => console.log("Document successfully deleted!"))
            .catch(error => console.error("Error removing document: ", error));
      }
    }

    // --- UPDATED: renderTable function with new Reconciliation logic ---
    function renderTable(tab, query) {
        const lowerQuery = query.toLowerCase();
        const tbody = document.getElementById(`${tab}-table`);
        let html = '';

        if (tab === 'operation' || tab === 'procurement') {
            const filteredData = courierData.filter(c => 
                c.category === tab &&
                (c.requestId.toLowerCase().includes(lowerQuery) || 
                 c.vendorName.toLowerCase().includes(lowerQuery) || 
                 (c.clientName && c.clientName.toLowerCase().includes(lowerQuery)) ||
                 c.courierName.toLowerCase().includes(lowerQuery) || 
                 c.trackingId.toLowerCase().includes(lowerQuery))
            );

            html = filteredData.map(c => `
                <tr class="border-t hover:bg-gray-50">
                    <td class="p-2">${c.requestId}</td>
                    <td>${c.vendorName}</td>
                    <td>${c.clientName}</td>
                    <td>${c.courierName}</td>
                    <td>${c.trackingId}</td>
                    <td>${c.quantityReceived}/${c.totalQuantity}</td>
                    ${tab === 'procurement' ? `<td class="font-medium ${c.status === 'Completed' ? 'text-green-600' : c.status === 'Partially Received' ? 'text-yellow-600' : ''}">${c.status}</td>` : ''}
                    <td class="p-2">
                        <button onclick="openModal('${c.id}')" class="text-blue-600 hover:underline">Edit</button> |
                        <button onclick="deleteCourier('${c.id}')" class="text-red-600 hover:underline">Delete</button> |
                        <button onclick="openQuantityModal('${c.id}')" class="text-green-600 hover:underline">Update Qty</button>
                    </td>
                </tr>`).join('');
        
        } else if (tab === 'reconciliation') {
            const procurementItems = courierData.filter(c => c.category === 'procurement');
            const operationItems = courierData.filter(c => c.category === 'operation');
            let reconciledData = [];

            procurementItems.forEach(pItem => {
                const oItem = operationItems.find(o => o.requestId === pItem.requestId);
                if (oItem) {
                    reconciledData.push({
                        requestId: pItem.requestId,
                        vendorName: pItem.vendorName,
                        clientName: pItem.clientName, // Including client name
                        procurementQty: pItem.quantityReceived || 0,
                        operationQty: oItem.quantityReceived || 0,
                        difference: (pItem.quantityReceived || 0) - (oItem.quantityReceived || 0)
                    });
                }
            });

            const filteredReconciled = reconciledData.filter(r => 
                r.requestId.toLowerCase().includes(lowerQuery) ||
                r.vendorName.toLowerCase().includes(lowerQuery) ||
                (r.clientName && r.clientName.toLowerCase().includes(lowerQuery))
            );

            html = filteredReconciled.map(r => `
                <tr class="border-t hover:bg-gray-50">
                    <td class="p-2">${r.requestId}</td>
                    <td>${r.vendorName}</td>
                    <td>${r.clientName}</td>
                    <td>${r.procurementQty}</td>
                    <td>${r.operationQty}</td>
                    <td class="font-bold ${r.difference !== 0 ? 'text-red-500' : 'text-green-500'}">${r.difference}</td>
                </tr>`).join('');
        }

        tbody.innerHTML = html || `<tr><td colspan="8" class="text-center text-gray-500 p-4">No records found</td></tr>`;
    }


    function exportCSV() {
        if(courierData.length === 0) {
            alert("No data to export.");
            return;
        }
        let csv = "Request ID,Vendor Name,Client Name,Courier Name,Tracking ID,Total Quantity,Quantity Received,Category,Status\n";
        courierData.forEach(c => {
            csv += `${c.requestId || ''},${c.vendorName || ''},${c.clientName || ''},${c.courierName || ''},${c.trackingId || ''},${c.totalQuantity || 0},${c.quantityReceived || 0},${c.category || ''},${c.status || ''}\n`;
        });
        const blob = new Blob([csv], {type: 'text/csv'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "courier_data.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    courierCollection.onSnapshot(snapshot => {
        courierData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderTable(currentTab, document.querySelector(`#search-${currentTab} input`).value || '');
    }, error => {
        console.error("Error fetching data from Firestore: ", error);
    });

    document.addEventListener('DOMContentLoaded', () => {
      switchTab('operation', document.querySelector('.tab-button'));
    });
  </script>
</body>
</html>
